================================================================================
üéØ DOCUMENTACI√ìN COMPLETA: ENDPOINT ACTUALIZAR RETENCI√ìN DE FUENTE
================================================================================

üìã √çNDICE:
1. Resumen del Endpoint
2. C√≥digo Backend (Java Spring Boot)
   2.1. DTO: RetencionFuenteDTO.java
   2.2. Service: OrdenService.java (m√©todo actualizarRetencionFuente)
   2.3. Controller: OrdenController.java (endpoint PUT)
3. C√≥digo Frontend (JavaScript/React)
   3.1. Servicio API
   3.2. Uso en componente
4. Ejemplos de Uso
5. Manejo de Errores

================================================================================
1. RESUMEN DEL ENDPOINT
================================================================================

M√âTODO:     PUT
URL:        /api/ordenes/{id}/retencion-fuente
PROP√ìSITO:  Actualizar SOLO los campos de retenci√≥n de fuente sin enviar 
            todos los datos de la orden

VENTAJAS:
‚úÖ Menos datos enviados (solo lo necesario)
‚úÖ Menos errores (no necesitas reconstruir todo el payload)
‚úÖ M√°s seguro (evitas modificar otros campos accidentalmente)
‚úÖ M√°s r√°pido (menos procesamiento)
‚úÖ Actualiza autom√°ticamente el cr√©dito asociado si existe

REQUEST BODY:
{
  "tieneRetencionFuente": true,     // OBLIGATORIO: boolean
  "retencionFuente": 25000.50,      // OBLIGATORIO: n√∫mero (0.0 si no tiene retenci√≥n)
  "iva": 47500.00                   // OPCIONAL: n√∫mero (se calcula autom√°ticamente)
}

RESPONSE 200 OK:
{
  "mensaje": "Retenci√≥n de fuente actualizada exitosamente",
  "orden": {
    "id": 124,
    "numero": 1001,
    "fecha": "2025-12-16",
    "tieneRetencionFuente": true,
    "retencionFuente": 25000.50,
    "iva": 47500.00,
    "total": 297500.50,
    "creditoDetalle": {
      "id": 45,
      "totalCredito": 297500.50,
      "totalAbonado": 0.0,
      "saldoPendiente": 272500.00,  // total - retencionFuente
      "estado": "ABIERTO",
      ...
    },
    "cliente": { ... },
    "sede": { ... },
    "items": [ ... ],
    ...
  }
}

ERRORES POSIBLES:
- 400 Bad Request: Validaciones fallidas
- 404 Not Found: Orden no existe
- 500 Internal Server Error: Error inesperado

================================================================================
2. C√ìDIGO BACKEND (JAVA SPRING BOOT)
================================================================================

--------------------------------------------------------------------------------
2.1. DTO: RetencionFuenteDTO.java
--------------------------------------------------------------------------------
UBICACI√ìN: src/main/java/com/casaglass/casaglass_backend/dto/RetencionFuenteDTO.java

COPIAR Y PEGAR:

package com.casaglass.casaglass_backend.dto;

import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * üí∞ DTO PARA ACTUALIZAR RETENCI√ìN DE FUENTE EN UNA ORDEN
 * 
 * Este DTO se usa exclusivamente para actualizar los campos de retenci√≥n de fuente
 * sin necesidad de enviar todos los datos de la orden (items, cliente, sede, etc.)
 * 
 * Endpoint: PUT /api/ordenes/{id}/retencion-fuente
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RetencionFuenteDTO {
    
    /**
     * Indica si la orden tiene retenci√≥n de fuente aplicada
     * OBLIGATORIO
     */
    @NotNull(message = "El campo tieneRetencionFuente es obligatorio")
    private Boolean tieneRetencionFuente;
    
    /**
     * Valor monetario de la retenci√≥n en la fuente
     * Si tieneRetencionFuente = false, este valor debe ser 0.0
     */
    @NotNull(message = "El valor de retenci√≥n es obligatorio")
    private Double retencionFuente;
    
    /**
     * Valor del IVA recalculado (opcional)
     * Si no se env√≠a, el backend lo calcula autom√°ticamente
     */
    private Double iva;
}

--------------------------------------------------------------------------------
2.2. Service: OrdenService.java (agregar este m√©todo)
--------------------------------------------------------------------------------
UBICACI√ìN: src/main/java/com/casaglass/casaglass_backend/service/OrdenService.java

COPIAR Y PEGAR AL FINAL DE LA CLASE OrdenService (antes del cierre }):

    /**
     * üí∞ ACTUALIZAR RETENCI√ìN DE FUENTE DE UNA ORDEN
     * 
     * Endpoint especializado para actualizar SOLO los campos de retenci√≥n de fuente
     * sin necesidad de enviar todos los datos de la orden (items, cliente, sede, etc.)
     * 
     * Caracter√≠sticas:
     * - Actualiza tieneRetencionFuente, retencionFuente, e IVA
     * - Recalcula el total de la orden
     * - Si la orden tiene cr√©dito, actualiza tambi√©n el saldo del cr√©dito
     * - Validaciones de seguridad (orden debe existir y estar ACTIVA)
     * 
     * @param ordenId ID de la orden a actualizar
     * @param dto DTO con los nuevos valores de retenci√≥n
     * @return Orden actualizada con todos sus campos
     * @throws IllegalArgumentException si la orden no existe o est√° anulada
     */
    @Transactional
    public Orden actualizarRetencionFuente(Long ordenId, com.casaglass.casaglass_backend.dto.RetencionFuenteDTO dto) {
        System.out.println("üí∞ DEBUG: Actualizando retenci√≥n de fuente para orden ID: " + ordenId);
        System.out.println("üí∞ DEBUG: Datos recibidos: " + dto);
        
        // 1Ô∏è‚É£ BUSCAR ORDEN EXISTENTE
        Orden orden = repo.findById(ordenId)
            .orElseThrow(() -> new IllegalArgumentException("Orden no encontrada con ID: " + ordenId));
        
        // 2Ô∏è‚É£ VALIDAR QUE LA ORDEN EST√â ACTIVA
        if (orden.getEstado() == Orden.EstadoOrden.ANULADA) {
            throw new IllegalArgumentException("No se puede actualizar la retenci√≥n de una orden anulada");
        }
        
        // 3Ô∏è‚É£ VALIDAR DATOS DEL DTO
        if (dto.getTieneRetencionFuente() == null) {
            throw new IllegalArgumentException("El campo tieneRetencionFuente es obligatorio");
        }
        if (dto.getRetencionFuente() == null) {
            throw new IllegalArgumentException("El valor de retencionFuente es obligatorio");
        }
        
        // Si no tiene retenci√≥n, el valor debe ser 0
        if (!dto.getTieneRetencionFuente() && dto.getRetencionFuente() != 0.0) {
            throw new IllegalArgumentException("Si tieneRetencionFuente es false, retencionFuente debe ser 0.0");
        }
        
        // 4Ô∏è‚É£ ACTUALIZAR CAMPOS DE RETENCI√ìN
        orden.setTieneRetencionFuente(dto.getTieneRetencionFuente());
        orden.setRetencionFuente(dto.getRetencionFuente());
        
        // 5Ô∏è‚É£ ACTUALIZAR IVA SI SE PROPORCION√ì (OPCIONAL)
        if (dto.getIva() != null) {
            orden.setIva(dto.getIva());
            System.out.println("üí∞ DEBUG: IVA actualizado a: " + dto.getIva());
        }
        
        // 6Ô∏è‚É£ RECALCULAR TOTAL (suma de items - descuentos, SIN restar retenci√≥n)
        // El total facturado NO incluye la retenci√≥n restada
        // La retenci√≥n se resta solo para el saldo del cr√©dito
        double subtotalBruto = 0.0;
        if (orden.getItems() != null && !orden.getItems().isEmpty()) {
            for (OrdenItem item : orden.getItems()) {
                subtotalBruto += item.getTotalLinea() != null ? item.getTotalLinea() : 0.0;
            }
        }
        subtotalBruto = Math.round(subtotalBruto * 100.0) / 100.0;
        
        Double descuentos = orden.getDescuentos() != null ? orden.getDescuentos() : 0.0;
        Double totalFacturado = subtotalBruto - descuentos;
        totalFacturado = Math.round(totalFacturado * 100.0) / 100.0;
        
        orden.setTotal(totalFacturado);
        System.out.println("üí∞ DEBUG: Total facturado recalculado: " + totalFacturado);
        
        // 7Ô∏è‚É£ GUARDAR ORDEN
        Orden ordenActualizada = repo.save(orden);
        System.out.println("‚úÖ DEBUG: Orden actualizada exitosamente");
        
        // 8Ô∏è‚É£ ACTUALIZAR CR√âDITO SI EXISTE
        if (orden.isCredito() && orden.getCreditoDetalle() != null) {
            System.out.println("üí≥ DEBUG: Actualizando cr√©dito asociado...");
            creditoService.recalcularTotales(orden.getCreditoDetalle().getId());
            System.out.println("‚úÖ DEBUG: Cr√©dito recalculado exitosamente");
        }
        
        return ordenActualizada;
    }

--------------------------------------------------------------------------------
2.3. Controller: OrdenController.java (agregar este endpoint)
--------------------------------------------------------------------------------
UBICACI√ìN: src/main/java/com/casaglass/casaglass_backend/controller/OrdenController.java

COPIAR Y PEGAR DESPU√âS DEL M√âTODO obtenerProximoNumero() (antes de los endpoints de tabla):

    /**
     * üí∞ ACTUALIZAR RETENCI√ìN DE FUENTE DE UNA ORDEN
     * PUT /api/ordenes/{id}/retencion-fuente
     * 
     * Endpoint especializado para actualizar SOLO los campos de retenci√≥n de fuente
     * sin necesidad de enviar todos los datos de la orden (items, cliente, sede, etc.)
     * 
     * Request Body:
     * {
     *   "tieneRetencionFuente": true,     // OBLIGATORIO: boolean
     *   "retencionFuente": 25000.50,      // OBLIGATORIO: n√∫mero (0.0 si no tiene retenci√≥n)
     *   "iva": 47500.00                   // OPCIONAL: n√∫mero (se calcula autom√°ticamente si no se env√≠a)
     * }
     * 
     * Response 200 OK:
     * {
     *   "id": 124,
     *   "numero": 1001,
     *   "tieneRetencionFuente": true,
     *   "retencionFuente": 25000.50,
     *   "iva": 47500.00,
     *   "total": 297500.50,
     *   "creditoDetalle": {
     *     "id": 45,
     *     "saldoPendiente": 272500.00,
     *     ...
     *   },
     *   ...
     * }
     * 
     * Caracter√≠sticas:
     * - Actualiza tieneRetencionFuente, retencionFuente, e IVA
     * - Recalcula el total de la orden
     * - Si la orden tiene cr√©dito, actualiza tambi√©n el saldo del cr√©dito
     * - Validaciones de seguridad (orden debe existir y estar ACTIVA)
     * 
     * Errores posibles:
     * - 400 Bad Request: Validaciones fallidas (retenci√≥n inv√°lida, orden anulada)
     * - 404 Not Found: Orden no existe
     * - 500 Internal Server Error: Error inesperado
     */
    @PutMapping("/{id}/retencion-fuente")
    public ResponseEntity<?> actualizarRetencionFuente(
            @PathVariable Long id,
            @RequestBody com.casaglass.casaglass_backend.dto.RetencionFuenteDTO retencionDTO) {
        try {
            System.out.println("üí∞ DEBUG: Actualizando retenci√≥n de fuente para orden ID: " + id);
            System.out.println("üí∞ DEBUG: Datos recibidos: " + retencionDTO);
            
            Orden ordenActualizada = service.actualizarRetencionFuente(id, retencionDTO);
            
            System.out.println("‚úÖ DEBUG: Retenci√≥n actualizada exitosamente");
            
            return ResponseEntity.ok(Map.of(
                "mensaje", "Retenci√≥n de fuente actualizada exitosamente",
                "orden", ordenActualizada
            ));
        } catch (IllegalArgumentException e) {
            System.err.println("‚ùå ERROR VALIDACION: " + e.getMessage());
            return ResponseEntity.badRequest().body(Map.of(
                "error", e.getMessage(),
                "tipo", "VALIDACION"
            ));
        } catch (Exception e) {
            System.err.println("‚ùå ERROR SERVIDOR: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.internalServerError().body(Map.of(
                "error", "Error interno del servidor: " + e.getMessage(),
                "tipo", "SERVIDOR"
            ));
        }
    }

================================================================================
3. C√ìDIGO FRONTEND (JAVASCRIPT/REACT)
================================================================================

--------------------------------------------------------------------------------
3.1. Servicio API
--------------------------------------------------------------------------------
UBICACI√ìN: src/services/OrdenesService.js (o similar)

COPIAR Y PEGAR:

/**
 * üí∞ Actualizar retenci√≥n de fuente de una orden
 * 
 * Endpoint especializado para actualizar SOLO la retenci√≥n sin enviar todos los datos
 * 
 * @param {number} ordenId - ID de la orden
 * @param {Object} payload - Datos de retenci√≥n
 * @param {boolean} payload.tieneRetencionFuente - Si tiene retenci√≥n
 * @param {number} payload.retencionFuente - Valor de la retenci√≥n
 * @param {number} [payload.iva] - Valor del IVA (opcional)
 * @returns {Promise<Object>} Orden actualizada
 */
export async function actualizarRetencionFuente(ordenId, payload) {
  try {
    const { data } = await api.put(`/ordenes/${ordenId}/retencion-fuente`, {
      tieneRetencionFuente: payload.tieneRetencionFuente,
      retencionFuente: payload.retencionFuente,
      iva: payload.iva // Opcional
    });
    return data;
  } catch (error) {
    console.error('‚ùå Error actualizando retenci√≥n de fuente:', error);
    throw error;
  }
}

--------------------------------------------------------------------------------
3.2. Uso en Componente React
--------------------------------------------------------------------------------
UBICACI√ìN: Componente donde quieras usar la funci√≥n (ej: AbonoPage.jsx)

COPIAR Y PEGAR:

import { actualizarRetencionFuente } from '../services/OrdenesService';

// Dentro de tu componente:

const toggleRetencionOrden = async (orden) => {
  try {
    // Mostrar loading
    setLoading(true);
    
    // Calcular nuevo valor de retenci√≥n
    const nuevoValorRetencion = !orden.tieneRetencionFuente;
    
    // Obtener configuraci√≥n de retenci√≥n (% y umbral)
    const porcentajeRetencion = 2.5; // 2.5% - ajustar seg√∫n tu config
    const umbralRetencion = 800000; // Umbral m√≠nimo - ajustar seg√∫n tu config
    
    // Calcular valores
    const subtotalSinIva = orden.subtotal || 0;
    const retencionFuenteCalculada = nuevoValorRetencion && subtotalSinIva >= umbralRetencion
      ? Math.round((subtotalSinIva * (porcentajeRetencion / 100)) * 100) / 100
      : 0;
    
    // Llamar al endpoint especializado
    const response = await actualizarRetencionFuente(orden.id, {
      tieneRetencionFuente: nuevoValorRetencion,
      retencionFuente: retencionFuenteCalculada,
      iva: orden.iva // Opcional, puedes recalcular o enviar el actual
    });
    
    // Actualizar solo esta orden en el estado
    setOrdenesCredito(prev => 
      prev.map(o => o.id === orden.id ? response.orden : o)
    );
    
    // Mostrar mensaje de √©xito
    toast.success(response.mensaje || 'Retenci√≥n actualizada exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    // Manejo de errores espec√≠fico
    if (error.response?.data?.tipo === 'VALIDACION') {
      toast.error(error.response.data.error);
    } else {
      toast.error('Error al actualizar la retenci√≥n. Intente nuevamente.');
    }
  } finally {
    setLoading(false);
  }
};

================================================================================
4. EJEMPLOS DE USO
================================================================================

--------------------------------------------------------------------------------
EJEMPLO 1: Activar retenci√≥n de fuente
--------------------------------------------------------------------------------

REQUEST:
PUT /api/ordenes/124/retencion-fuente

{
  "tieneRetencionFuente": true,
  "retencionFuente": 25000.50
}

RESPONSE 200 OK:
{
  "mensaje": "Retenci√≥n de fuente actualizada exitosamente",
  "orden": {
    "id": 124,
    "numero": 1001,
    "tieneRetencionFuente": true,
    "retencionFuente": 25000.50,
    "total": 297500.50,
    "creditoDetalle": {
      "saldoPendiente": 272500.00  // total - retencion
    }
  }
}

--------------------------------------------------------------------------------
EJEMPLO 2: Desactivar retenci√≥n de fuente
--------------------------------------------------------------------------------

REQUEST:
PUT /api/ordenes/124/retencion-fuente

{
  "tieneRetencionFuente": false,
  "retencionFuente": 0.0
}

RESPONSE 200 OK:
{
  "mensaje": "Retenci√≥n de fuente actualizada exitosamente",
  "orden": {
    "id": 124,
    "numero": 1001,
    "tieneRetencionFuente": false,
    "retencionFuente": 0.0,
    "total": 297500.50,
    "creditoDetalle": {
      "saldoPendiente": 297500.50  // sin retenci√≥n
    }
  }
}

--------------------------------------------------------------------------------
EJEMPLO 3: Con IVA personalizado
--------------------------------------------------------------------------------

REQUEST:
PUT /api/ordenes/124/retencion-fuente

{
  "tieneRetencionFuente": true,
  "retencionFuente": 25000.50,
  "iva": 50000.00  // IVA recalculado manualmente
}

RESPONSE 200 OK:
{
  "mensaje": "Retenci√≥n de fuente actualizada exitosamente",
  "orden": {
    "id": 124,
    "iva": 50000.00,
    "retencionFuente": 25000.50,
    ...
  }
}

================================================================================
5. MANEJO DE ERRORES
================================================================================

--------------------------------------------------------------------------------
ERROR 400: Validaci√≥n fallida
--------------------------------------------------------------------------------

CASO 1: Orden anulada
{
  "error": "No se puede actualizar la retenci√≥n de una orden anulada",
  "tipo": "VALIDACION"
}

CASO 2: Campo obligatorio faltante
{
  "error": "El campo tieneRetencionFuente es obligatorio",
  "tipo": "VALIDACION"
}

CASO 3: Retenci√≥n inv√°lida
{
  "error": "Si tieneRetencionFuente es false, retencionFuente debe ser 0.0",
  "tipo": "VALIDACION"
}

--------------------------------------------------------------------------------
ERROR 404: Orden no encontrada
--------------------------------------------------------------------------------

{
  "error": "Orden no encontrada con ID: 999",
  "tipo": "VALIDACION"
}

--------------------------------------------------------------------------------
ERROR 500: Error interno del servidor
--------------------------------------------------------------------------------

{
  "error": "Error interno del servidor: [mensaje de error]",
  "tipo": "SERVIDOR"
}

================================================================================
6. VENTAJAS DE ESTE ENFOQUE
================================================================================

‚úÖ SIMPLICIDAD
   - Solo env√≠as 2-3 campos en lugar de todo el objeto orden
   - No necesitas reconstruir el payload completo

‚úÖ SEGURIDAD
   - No puedes modificar accidentalmente otros campos (cliente, items, etc.)
   - Validaciones espec√≠ficas para retenci√≥n

‚úÖ RENDIMIENTO
   - Menos datos transferidos
   - Procesamiento m√°s r√°pido

‚úÖ MANTENIBILIDAD
   - Cambios futuros en Orden no afectan este endpoint
   - C√≥digo m√°s limpio y espec√≠fico

‚úÖ CLARIDAD
   - La intenci√≥n es obvia: "actualizar retenci√≥n"
   - F√°cil de entender y usar

‚úÖ ACTUALIZACI√ìN AUTOM√ÅTICA DEL CR√âDITO
   - Si la orden tiene cr√©dito, el saldo se recalcula autom√°ticamente
   - No necesitas llamar endpoints adicionales

================================================================================
7. CHECKLIST DE IMPLEMENTACI√ìN
================================================================================

BACKEND:
[ ] Crear archivo RetencionFuenteDTO.java
[ ] Agregar m√©todo actualizarRetencionFuente en OrdenService.java
[ ] Agregar endpoint PUT en OrdenController.java
[ ] Compilar proyecto (mvn clean install)
[ ] Reiniciar servidor Spring Boot
[ ] Probar con Postman/Insomnia

FRONTEND:
[ ] Agregar funci√≥n actualizarRetencionFuente en OrdenesService.js
[ ] Implementar funci√≥n toggleRetencionOrden en componente
[ ] Probar en interfaz de usuario
[ ] Verificar que el cr√©dito se actualice correctamente

TESTING:
[ ] Probar activar retenci√≥n
[ ] Probar desactivar retenci√≥n
[ ] Probar con orden sin cr√©dito
[ ] Probar con orden con cr√©dito
[ ] Probar errores (orden anulada, no existe, etc.)

================================================================================
FIN DE LA DOCUMENTACI√ìN
================================================================================

¬°Listo para copiar y pegar! üöÄ

Si tienes alguna duda o necesitas ajustar algo, av√≠same.
